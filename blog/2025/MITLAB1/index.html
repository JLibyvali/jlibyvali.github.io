<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content="GVPkGz5sp8TF5HIgM709jCehvcUAvLW_uL-eBXsAI6U"> <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> MIT6.828/fall 2018 Lab 1 | JLibyvali </title> <meta name="author" content="JLibyvali "> <meta name="description" content="Notes about lab 1"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.4/dist/bootstrap-table.min.css" integrity="sha256-uRX+PiRTR4ysKFRCykT8HLuRCub26LgXJZym3Yeom1c=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/avatar.jpg?aa24916676dfcaaf5ca19ff8602834c0"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://jlibyvali.github.io/blog/2025/MITLAB1/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">JLibyvali</span> </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">Home </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">MIT6.828/fall 2018 Lab 1</h1> <p class="post-meta"> Created in January 15, 2025 </p> <p class="post-tags"> <a href="/blog/2025"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </a>   ·   <a href="/blog/category/system"> <i class="fa-solid fa-tag fa-sm"></i> system</a> </p> </header> <article class="post-content"> <div id="table-of-contents"> <ul id="toc" class="section-nav"> <li class="toc-entry toc-h1"> <a href="#lab1-notes">Lab1 Notes</a> <ul> <li class="toc-entry toc-h2"><a href="#pre-required">Pre-required</a></li> <li class="toc-entry toc-h2"> <a href="#parts">PARTS</a> <ul> <li class="toc-entry toc-h3"><a href="#part-i-the-rom-bios">PART I. the ROM BIOS</a></li> <li class="toc-entry toc-h3"> <a href="#part-ii-boot-loader">PART II. Boot Loader</a> <ul> <li class="toc-entry toc-h4"><a href="#loading-kernel">Loading Kernel</a></li> </ul> </li> <li class="toc-entry toc-h3"> <a href="#part-iii-kernel">PART III. Kernel</a> <ul> <li class="toc-entry toc-h4"><a href="#using-virtual-memory-to-work-around-position-dependence">Using virtual memory to work around position dependence</a></li> <li class="toc-entry toc-h4"> <a href="#formatted-printing-to-the-console">Formatted Printing to the Console</a> <ul> <li class="toc-entry toc-h5"><a href="#challenge">Challenge</a></li> </ul> </li> <li class="toc-entry toc-h4"><a href="#stack">Stack</a></li> </ul> </li> </ul> </li> </ul> </li> </ul> </div> <hr> <div id="markdown-content"> <h1 id="lab1-notes">Lab1 Notes</h1> <h2 id="pre-required">Pre-required</h2> <p>1GBit: 0x40000000(Hex)<br> 1MBit: 0x100000(Hex)<br> 1KBit: 0x400(Hex)</p> <blockquote> <p>16-bit Intel 8088 hard-wired memory layout.</p> </blockquote> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">+------------------+</span>  <span class="o">&lt;-</span> <span class="mh">0xFFFFFFFF</span> <span class="p">(</span><span class="mi">4</span><span class="n">GB</span><span class="p">)</span>
<span class="o">|</span>      <span class="mi">32</span><span class="o">-</span><span class="n">bit</span>      <span class="o">|</span>
<span class="o">|</span>  <span class="n">memory</span> <span class="n">mapped</span>   <span class="o">|</span>
<span class="o">|</span>     <span class="n">devices</span>      <span class="o">|</span>
<span class="o">|</span>                  <span class="o">|</span>
<span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span>\

<span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="o">/</span>\
<span class="o">|</span>                  <span class="o">|</span>
<span class="o">|</span>      <span class="n">Unused</span>      <span class="o">|</span>
<span class="o">|</span>                  <span class="o">|</span>
<span class="o">+------------------+</span>  <span class="o">&lt;-</span> <span class="n">depends</span> <span class="n">on</span> <span class="n">amount</span> <span class="n">of</span> <span class="n">RAM</span>
<span class="o">|</span>                  <span class="o">|</span>
<span class="o">|</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="n">Extended</span> <span class="n">Memory</span>  <span class="o">|</span>
<span class="o">|</span>                  <span class="o">|</span>
<span class="o">|</span>                  <span class="o">|</span>
<span class="o">+------------------+</span>  <span class="o">&lt;-</span> <span class="mh">0x00100000</span> <span class="p">(</span><span class="mi">1</span><span class="n">MB</span><span class="p">)</span>
<span class="o">|</span>     <span class="n">BIOS</span> <span class="n">ROM</span>     <span class="o">|</span>
<span class="o">+------------------+</span>  <span class="o">&lt;-</span> <span class="mh">0x000F0000</span> <span class="p">(</span><span class="mi">960</span><span class="n">KB</span><span class="p">)</span>
<span class="o">|</span>  <span class="mi">16</span><span class="o">-</span><span class="n">bit</span> <span class="n">devices</span><span class="p">,</span> <span class="o">|</span>
<span class="o">|</span>  <span class="n">expansion</span> <span class="n">ROMs</span>  <span class="o">|</span>
<span class="o">+------------------+</span>  <span class="o">&lt;-</span> <span class="mh">0x000C0000</span> <span class="p">(</span><span class="mi">768</span><span class="n">KB</span><span class="p">)</span>
<span class="o">|</span>   <span class="n">VGA</span> <span class="n">Display</span>    <span class="o">|</span>
<span class="o">+------------------+</span>  <span class="o">&lt;-</span> <span class="mh">0x000A0000</span> <span class="p">(</span><span class="mi">640</span><span class="n">KB</span><span class="p">)</span>
<span class="o">|</span>                  <span class="o">|</span>
<span class="o">|</span>    <span class="n">Low</span> <span class="n">Memory</span>    <span class="o">|</span>
<span class="o">|</span>                  <span class="o">|</span>
<span class="o">+------------------+</span>  <span class="o">&lt;-</span> <span class="mh">0x00000000</span>  

</code></pre></div></div> <p>Real Mode: BIOS can get control of all machine address after power-up, which is Crucial because non any-software code in RAM can be executed by processor.</p> <h2 id="parts">PARTS</h2> <h3 id="part-i-the-rom-bios">PART I. the ROM BIOS</h3> <p>At GDB First Debug stop, we can know something about real mode.<br> QEMU places it own BIOS(called SeaBIOS) at the segment address (CS=0xf000:IP=0xfff0) = 0xffff0 physical address.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="p">[</span><span class="n">f000</span><span class="o">:</span><span class="n">fff0</span><span class="p">]</span> <span class="mh">0xffff0</span><span class="o">:</span>	<span class="n">ljmp</span>   <span class="err">$</span><span class="mh">0xf000</span><span class="p">,</span><span class="err">$</span><span class="mh">0xe05b</span>

<span class="c1">// The IBM PC starts executing at physical address 0x000ffff0, which is at the very top of the 64KB area reserved for the ROM BIOS.</span>
<span class="c1">// The PC starts executing with CS = 0xf000 and IP = 0xfff0.</span>
<span class="c1">// The first instruction to be executed is a jmp instruction, which jumps to the `segmented address` CS = 0xf000 and IP = 0xe05b.  </span>

</code></pre></div></div> <p>So instruction begin at (CS:IP) segment address. And will execute an instruction that <code class="language-plaintext highlighter-rouge">jmp</code> to (CS=0xf000:IP=0xe05b)</p> <p>Intel broke the barrier of 1MB RAM in processor 80286 and 80386. So PC architectures preserved the Origin memory layout to keep backward compatibility. Therefore, modern PC have a <code class="language-plaintext highlighter-rouge">hole</code> in physical memory from <code class="language-plaintext highlighter-rouge">0x000A0000 -&gt; 0x00100000</code>, which dividing the memory into <code class="language-plaintext highlighter-rouge">low memory</code> and <code class="language-plaintext highlighter-rouge">extended memory</code> .</p> <hr> <ul> <li>Ex.2 Figure out the general idea of what BIOS done.</li> </ul> <blockquote> <p>CPU is in Real-Mode, BIOS sets up an Interrupt Descriptor Table and initialized some devices like VGA. this is the BIOS message <code class="language-plaintext highlighter-rouge">Starting SeaBIOS</code> where com from.<br> Initialized PCI bus and all important device BIOS know about.<br> After that, searched all possible bootable devices like a floppy,hard drive, CD-ROM. Then read the <code class="language-plaintext highlighter-rouge">boot loader</code> into RAM.</p> </blockquote> <h3 id="part-ii-boot-loader">PART II. Boot Loader</h3> <p>Hard disk for PCs is divided into 512 bytes region called sector, which is also the disk’s minimum transfer granularity: <code class="language-plaintext highlighter-rouge">read or write operations must be one or more sectors in size and aligned on a sector boundary.</code> <br> When BIOS find a bootable disk, it will read disk first sector into physical address <code class="language-plaintext highlighter-rouge">0x7c00 - 0x7dff</code>, and use <code class="language-plaintext highlighter-rouge">jmp</code> instruction to set (CS = 0000 : IP = 7c00), passing Machine control to boot loader.</p> <hr> <p><strong>Read code boot.S, main.c boot.asm</strong></p> <p><strong>Pre-required: read the Makefile and .gdbinit. realize the ELF format, using <code class="language-plaintext highlighter-rouge">readelf</code> and <code class="language-plaintext highlighter-rouge">objdump</code> tool help understand code.</strong></p> <hr> <blockquote> <p>GNUmakefile:<br> Top-level makefile, describe the info <code class="language-plaintext highlighter-rouge">make target rule</code>, boot/Makefrag nad kern/Makefrag responsible for compile code.</p> </blockquote> <blockquote> <p>.gdbinit:<br> When you <code class="language-plaintext highlighter-rouge">make gdb</code> its the configuration file of gdb, connect to QEMU target and run a loop which <code class="language-plaintext highlighter-rouge">translate the segment address to physical address</code> both in processor 16bit and 32bit mode.</p> </blockquote> <blockquote> <p>boot/Makefrag: <br> Compiling the boot.o main.o boot.out. Link the boot.out(also the bootloader) with ` $(V)$(LD) $(LDFLAGS) -N -e start -Ttext 0x7C00 -o $@.out $^`</p> </blockquote> <blockquote> <p>kern/Makefrag: <br> using LD script to linking.</p> </blockquote> <blockquote> <p>boot.S:</p> <ol> <li>Switch the processor from real-mode to 32bit protected mode, because Only in this mode software can access all memory above 1MB in processor’s physical address space. And jmp to <code class="language-plaintext highlighter-rouge">bootmain</code> function. If failed, jumped into a infinite loop.</li> <li>Set the stack pointer for <code class="language-plaintext highlighter-rouge">bootmain</code> function and loading a Bootstrap GDT to make virtual address translate.</li> </ol> </blockquote> <blockquote> <p>main.c:<br> Read the kernel from IDE disk device via x86’s specific instructions(like <code class="language-plaintext highlighter-rouge">outb</code>, <code class="language-plaintext highlighter-rouge">inb</code>). In details, it reads via a ELF format struct, and call the kernel entry by ELF struct member, i.e. a function pointer. the main.c not returned.</p> </blockquote> <blockquote> <p>boot.asm: <br> the disassembled code from <code class="language-plaintext highlighter-rouge">boot.out</code> ELF executable file. Reads it with GDB <code class="language-plaintext highlighter-rouge">x /Ni ADDR</code> instruction can help you identify where you are.</p> </blockquote> <hr> <ul> <li>Ex.3 Using GDB debug the bootloader, examine the progress to kernel.</li> </ul> <p><code class="language-plaintext highlighter-rouge">0x7c00</code> enter the <code class="language-plaintext highlighter-rouge">boot.S</code> program code, and if every thing OK, it will call <code class="language-plaintext highlighter-rouge">bootmain()</code> function at[0x7d19].<br> the <code class="language-plaintext highlighter-rouge">bootmain()</code> function will read segment-address data to <code class="language-plaintext highlighter-rouge">ELF-HEADER</code> address(0x100000).</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="cp">#define ELFHDR		((struct Elf *) 0x10000) // 1MB address load the kernel.img. and type is `struct Elf`, so can access members by offset. 
</span>	<span class="c1">// and it's a macro, also in disassembled file code.  </span>

	<span class="k">struct</span> <span class="n">Proghdr</span> <span class="o">*</span><span class="n">ph</span><span class="p">,</span> <span class="o">*</span><span class="n">eph</span><span class="p">;</span>

	<span class="c1">// read 1st page off disk, and `readsect()` is really read function using x86 instructions.  </span>
	<span class="n">readseg</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">ELFHDR</span><span class="p">,</span> <span class="n">SECTSIZE</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="c1">// is this a valid ELF?</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ELFHDR</span><span class="o">-&gt;</span><span class="n">e_magic</span> <span class="o">!=</span> <span class="n">ELF_MAGIC</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>

	<span class="c1">// load each program segment (ignores ph flags)</span>
	<span class="n">ph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Proghdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ELFHDR</span> <span class="o">+</span> <span class="n">ELFHDR</span><span class="o">-&gt;</span><span class="n">e_phoff</span><span class="p">);</span>
	<span class="n">eph</span> <span class="o">=</span> <span class="n">ph</span> <span class="o">+</span> <span class="n">ELFHDR</span><span class="o">-&gt;</span><span class="n">e_phnum</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(;</span> <span class="n">ph</span> <span class="o">&lt;</span> <span class="n">eph</span><span class="p">;</span> <span class="n">ph</span><span class="o">++</span><span class="p">)</span>
		<span class="c1">// p_pa is the load address of this segment (as well</span>
		<span class="c1">// as the physical address)</span>
		<span class="n">readseg</span><span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_pa</span><span class="p">,</span> <span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_memsz</span><span class="p">,</span> <span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_offset</span><span class="p">);</span>
	<span class="cm">/** ASM for-loop 
	7d56:	39 f3                	cmp    %esi,%ebx
    7d58:	73 17                	jae    7d71 &lt;bootmain+0x58&gt;
    7d5a:	50                   	push   %eax
    7d5b:	83 c3 20             	add    $0x20,%ebx
    7d5e:	ff 73 e4             	push   -0x1c(%ebx)
    7d61:	ff 73 f4             	push   -0xc(%ebx)
    7d64:	ff 73 ec             	push   -0x14(%ebx)
    7d67:	e8 6e ff ff ff       	call   7cda &lt;readseg&gt;
    7d6c:	83 c4 10             	add    $0x10,%esp
    7d6f:	eb e5                	jmp    7d56 &lt;bootmain+0x3d&gt;
	 */</span>

	<span class="c1">// call the entry point from the ELF header</span>
	<span class="c1">//ASM     7d71:	ff 15 18 00 01 00    	call   *0x10018</span>
	<span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span> <span class="p">(</span><span class="n">ELFHDR</span><span class="o">-&gt;</span><span class="n">e_entry</span><span class="p">))();</span>	

</code></pre></div></div> <blockquote> <p><code class="language-plaintext highlighter-rouge">[Q]?</code> At what point does the processor start executing 32-bit code? What exactly causes the switch from 16-bit to 32-bit mode?</p> </blockquote> <p>In <code class="language-plaintext highlighter-rouge">boot.S</code> code <code class="language-plaintext highlighter-rouge">seta20.2</code> label, the instructions <code class="language-plaintext highlighter-rouge">.code32</code> made this conversion happened.</p> <blockquote> <p><code class="language-plaintext highlighter-rouge">[Q]?</code> What is the last instruction of the boot loader executed, and what is the first instruction of the kernel it just loaded?</p> </blockquote> <p>The last instruction of boot loader is in <code class="language-plaintext highlighter-rouge">boot/main.c</code>, instruction: ` 7d71: ff 15 18 00 01 00 call *0x10018 <code class="language-plaintext highlighter-rouge">. The first instruction of kernel is in </code>kern/entry.S`, the instruction:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nl">entry:</span>
	<span class="n">movw</span>	<span class="err">$</span><span class="mh">0x1234</span><span class="p">,</span><span class="mh">0x472</span>			<span class="err">#</span> <span class="n">warm</span> <span class="n">boot</span>  
</code></pre></div></div> <blockquote> <p><code class="language-plaintext highlighter-rouge">[Q]?</code> Where is the first instruction of the kernel?</p> </blockquote> <p>In kern/entry.S</p> <blockquote> <p><code class="language-plaintext highlighter-rouge">[Q]?</code> How does the boot loader decide how many sectors it must read in order to fetch the entire kernel from disk? Where does it find this information?</p> </blockquote> <p>Using ELF header struct members. First read a page size memory to address[0x100000] with the struct Elf type. then access struct Elf to get the ELF file end page offset. Then using <code class="language-plaintext highlighter-rouge">readsegt()</code> function to read correct num sectors.</p> <h4 id="loading-kernel">Loading Kernel</h4> <hr> <p>In this sections, using the <code class="language-plaintext highlighter-rouge">objdump</code> to read <code class="language-plaintext highlighter-rouge">obj/kern/kern and obj/boot/boot.out</code> various header tale information. See wiki to know ELF format and its tables <a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format" rel="external nofollow noopener" target="_blank">https://en.wikipedia.org/wiki/Executable_and_Linkable_Format</a>.<br> <code class="language-plaintext highlighter-rouge">objdump -h </code> read the ELF file section table, it contains all section in this ELF file.</p> <p>Like:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Idx</span> <span class="n">Name</span>          <span class="n">Size</span>      <span class="n">VMA</span>       <span class="n">LMA</span>       <span class="n">File</span> <span class="n">off</span>  <span class="n">Algn</span>
  <span class="mi">1</span> <span class="p">.</span><span class="n">text</span>         <span class="mo">000001</span><span class="mi">8</span><span class="n">c</span>  <span class="mo">00007</span><span class="n">c00</span>  <span class="mo">00007</span><span class="n">c00</span>  <span class="mo">000000</span><span class="n">d4</span>  <span class="mi">2</span><span class="o">**</span><span class="mi">2</span>
                  <span class="n">CONTENTS</span><span class="p">,</span> <span class="n">ALLOC</span><span class="p">,</span> <span class="n">LOAD</span><span class="p">,</span> <span class="n">CODE</span>

</code></pre></div></div> <p>VMA(link address) is the address from which section expected to executed, LMA(load address) is the memory address which section wanna be loaded into memory.</p> <p>The linker encodes the link address in the binary in various ways, such as when the code needs the <code class="language-plaintext highlighter-rouge">address of a global variable</code>, with the result that a binary usually won’t work if it is executing from an address that it’s not expected linked for. (It’s OK to generate positions-independent code)</p> <p><code class="language-plaintext highlighter-rouge">objdump -p </code> read the ELF file program header table, it contains the areas of ELF file need be loaded into memory, marked as <code class="language-plaintext highlighter-rouge">LOAD</code>. and another information:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">Program</span> <span class="n">Header</span><span class="o">:</span>
    <span class="n">LOAD</span> <span class="n">off</span>    <span class="mh">0x000000d4</span> <span class="n">vaddr</span> <span class="mh">0x00007c00</span> <span class="n">paddr</span> <span class="mh">0x00007c00</span> <span class="n">align</span> <span class="mi">2</span><span class="o">**</span><span class="mi">2</span>
         <span class="n">filesz</span> <span class="mh">0x00000228</span> <span class="n">memsz</span> <span class="mh">0x00000228</span> <span class="n">flags</span> <span class="n">rwx</span>

</code></pre></div></div> <hr> <ul> <li>Ex.5: Then change the link address in boot/Makefrag to something wrong</li> </ul> <p>I know what will happen.</p> <hr> <ul> <li>Ex.6: Examine the 8 words of memory at 0x00100000 at the point the BIOS enters the boot loader, and then again at the point the boot loader enters the kernel. Why are they different?</li> </ul> <p>Just thinking, because loading the kernel.img ELF file into <code class="language-plaintext highlighter-rouge">0x00100000</code> physical address, so after bootloader cal kernel.ing entry point, the 8 words after <code class="language-plaintext highlighter-rouge">0x00100000</code> is full of kern.img <code class="language-plaintext highlighter-rouge">.text</code> section data.</p> <h3 id="part-iii-kernel">PART III. Kernel</h3> <h4 id="using-virtual-memory-to-work-around-position-dependence">Using virtual memory to work around position dependence</h4> <p>AS we can see above, the <code class="language-plaintext highlighter-rouge">boot.out</code> link address is equaled with load address, case its the raw physical address, but <code class="language-plaintext highlighter-rouge">kern</code> link address<code class="language-plaintext highlighter-rouge">0xf0100000</code> is different with load address<code class="language-plaintext highlighter-rouge">0x00100000</code>. <br> Case the <code class="language-plaintext highlighter-rouge">kernel</code> always wanna linking at very high virtual address so that low address space used for user program. <br> Up until <code class="language-plaintext highlighter-rouge">kern/entry.S</code> sets the CR0_PG flag (via writing a register), memory reference are treated as physical address. Once CR0_PG flag set, memory references are virtual address that translated by hardware to physical address.<br> SO We need do a map about conversion of virtual address and physical address. In this lab we will map 4MB spaces.<code class="language-plaintext highlighter-rouge">entrypgdir.c</code> finished two map. 1. From kernel memory space <code class="language-plaintext highlighter-rouge">0xf0000000 - 0xf0400000</code> to physical space <code class="language-plaintext highlighter-rouge">0x00000000 - 0x00400000</code>. 2. From virtual memory space <code class="language-plaintext highlighter-rouge">0x00000000 - 0x00400000</code> to physical memory space.</p> <hr> <ul> <li>Ex.7: What is the first instruction after the new mapping is established that would fail to work properly if the mapping weren’t in place?</li> </ul> <p>After the instruction <code class="language-plaintext highlighter-rouge">f0100025: 0f 22 c0 mov %eax,%cr0</code>, the kernel address <code class="language-plaintext highlighter-rouge">0xf0100000</code> is mapped into physical address <code class="language-plaintext highlighter-rouge">0x00100000</code>. So the <code class="language-plaintext highlighter-rouge">x /8x ADDR</code> data result is the same.<br> So the first instruction would failed if not mapped properly is</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">f0100028:</span>	<span class="n">b8</span> <span class="mi">2</span><span class="n">f</span> <span class="mo">00</span> <span class="mi">10</span> <span class="n">f0</span>       	<span class="n">mov</span>    <span class="err">$</span><span class="mh">0xf010002f</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="n">f010002d</span><span class="o">:</span>	<span class="n">ff</span> <span class="n">e0</span>                	<span class="n">jmp</span>    <span class="o">*%</span><span class="n">eax</span>
</code></pre></div></div> <p>Because it using the kernel virtual address to call function. If we comment that statements:<br> We will get error,</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xf0100026</span> <span class="o">&lt;</span><span class="n">relocated</span><span class="o">+</span><span class="mi">2</span><span class="o">&gt;:</span>    <span class="n">Error</span> <span class="k">while</span> <span class="n">running</span> <span class="n">hook_stop</span><span class="o">:</span>  
<span class="n">Cannot</span> <span class="n">access</span> <span class="n">memory</span> <span class="n">at</span> <span class="n">address</span> <span class="mh">0xf0100026</span>      
</code></pre></div></div> <h4 id="formatted-printing-to-the-console">Formatted Printing to the Console</h4> <p><code class="language-plaintext highlighter-rouge">printf.c</code> implemented basic print function formatted print function, variadic arguments printf function.<br> <code class="language-plaintext highlighter-rouge">printfmt.c</code> implemented various formatted print functions.<br> <code class="language-plaintext highlighter-rouge">console.c</code> implemented the terminal console and initialized some IO devices via writing the register.</p> <hr> <ul> <li>Ex.8: We have omitted a small fragment of code - the code necessary to print octal numbers using patterns of the form “%o”. Find and fill in this code fragment.</li> </ul> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// (unsigned) octal</span>
<span class="k">case</span> <span class="sc">'o'</span><span class="p">:</span>
  <span class="n">num</span> <span class="o">=</span> <span class="n">getuint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="p">,</span> <span class="n">lflag</span><span class="p">);</span>
  <span class="n">base</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
  <span class="k">goto</span> <span class="n">number</span><span class="p">;</span>  


</code></pre></div></div> <blockquote> <p><code class="language-plaintext highlighter-rouge">[Q]?</code> Explain the interface between printf.c and console.c. Specifically, what function does console.c export? How is this function used by printf.c?</p> </blockquote> <ul> <li>printf.c</li> </ul> <p><code class="language-plaintext highlighter-rouge">putch()</code> output a char to console, invoke the interface of <code class="language-plaintext highlighter-rouge">console.c</code>.<br> <code class="language-plaintext highlighter-rouge">vcprintf()</code> output a formatted string and calculating the output char counts. Invoked the <code class="language-plaintext highlighter-rouge">vprintfmt()</code> of <code class="language-plaintext highlighter-rouge">printfmt.c</code>.<br> <code class="language-plaintext highlighter-rouge">cprint()</code> the C-style like print function.</p> <ul> <li>console.c</li> </ul> <p>Mainly implement IO device initialized function such as Serial, Parallel Port, CGA/VGA Display, Keyboard. And general device independent function owned by CONSOLE. Export these interface: <code class="language-plaintext highlighter-rouge">cons_getc(void)</code>, <code class="language-plaintext highlighter-rouge">cons_init(void)</code>, <code class="language-plaintext highlighter-rouge">cputchar(int)</code>, <code class="language-plaintext highlighter-rouge">cgetchar(void)</code>, <code class="language-plaintext highlighter-rouge">iscons(void)</code>.</p> <blockquote> <p><code class="language-plaintext highlighter-rouge">[Q]?</code> Explain the following from console.c:</p> </blockquote> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">1</span>      <span class="nf">if</span> <span class="p">(</span><span class="n">crt_pos</span> <span class="o">&gt;=</span> <span class="n">CRT_SIZE</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">2</span>              <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="mi">3</span>              <span class="n">memmove</span><span class="p">(</span><span class="n">crt_buf</span><span class="p">,</span> <span class="n">crt_buf</span> <span class="o">+</span> <span class="n">CRT_COLS</span><span class="p">,</span> <span class="p">(</span><span class="n">CRT_SIZE</span> <span class="o">-</span> <span class="n">CRT_COLS</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">));</span>
<span class="mi">4</span>              <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">CRT_SIZE</span> <span class="o">-</span> <span class="n">CRT_COLS</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CRT_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="mi">5</span>                      <span class="n">crt_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0700</span> <span class="o">|</span> <span class="sc">' '</span><span class="p">;</span>
<span class="mi">6</span>              <span class="n">crt_pos</span> <span class="o">-=</span> <span class="n">CRT_COLS</span><span class="p">;</span>
<span class="mi">7</span>      <span class="p">}</span>
</code></pre></div></div> <p>CONSOLE using <code class="language-plaintext highlighter-rouge">crt_buf</code> and <code class="language-plaintext highlighter-rouge">crt_pos</code> to output char and recording output positions. SO if output char had filled on page screen,<br> Clear current output buffer, and reset <code class="language-plaintext highlighter-rouge">crt_pos</code> to next new screen.</p> <blockquote> <p><code class="language-plaintext highlighter-rouge">[Q]?</code> Trace the execution of the following code step-by-step? These notes cover GCC’s calling convention on the x86.</p> </blockquote> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="n">cprintf</span><span class="p">(</span><span class="s">"x %d, y %x, z %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>  

</code></pre></div></div> <ul> <li>In the call to cprintf(), to what does <code class="language-plaintext highlighter-rouge">fmt</code> point? To what does <code class="language-plaintext highlighter-rouge">ap</code> point?</li> </ul> <p><code class="language-plaintext highlighter-rouge">cprintf()</code> declaration: <code class="language-plaintext highlighter-rouge">cprintf(const char *fmt, ...)</code>, so <code class="language-plaintext highlighter-rouge">fmt</code> point to <code class="language-plaintext highlighter-rouge">"x %d, y %x, z %d\n"</code> string, <code class="language-plaintext highlighter-rouge">ap</code> point to arguments list address in order.</p> <ul> <li>List (in order of execution) each call to <code class="language-plaintext highlighter-rouge">cons_putc</code>, <code class="language-plaintext highlighter-rouge">va_arg</code>, and <code class="language-plaintext highlighter-rouge">vcprintf</code>. For <code class="language-plaintext highlighter-rouge">cons_putc</code>, list its argument as well. For <code class="language-plaintext highlighter-rouge">va_arg</code>, list what <code class="language-plaintext highlighter-rouge">ap</code> points to before and after the call. For <code class="language-plaintext highlighter-rouge">vcprintf</code> list the values of its two arguments.</li> </ul> <p><code class="language-plaintext highlighter-rouge">cons_putc()</code> is in <code class="language-plaintext highlighter-rouge">console.c</code>, it defined write char to devices. <code class="language-plaintext highlighter-rouge">cons_putc()</code> is wrapped by <code class="language-plaintext highlighter-rouge">printf.c/putch()</code>, <code class="language-plaintext highlighter-rouge">putch()</code> as callback for some function in <code class="language-plaintext highlighter-rouge">printfmt.c</code>. <br> <code class="language-plaintext highlighter-rouge">va_arg</code> used for parsing <code class="language-plaintext highlighter-rouge">va_list ap</code> pointer, mainly used in printfmt.c <code class="language-plaintext highlighter-rouge">getint()/getuint()/vprintfmt()</code> functions. <br> <code class="language-plaintext highlighter-rouge">vcprintf()</code> defined in <code class="language-plaintext highlighter-rouge">printf.c</code>, to print specific arguments parsed in <code class="language-plaintext highlighter-rouge">cprintf()</code> function.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cm">/* Call Stack: 
cprintf(const char* fmt, ...) 
\/
vcprintf(const char* fmt, va_list ap)
\/
void vprintfmt(void (*putch)(int, void *), void *putdat, const char *fmt, va_list ap)
\/
printnum()/putch(int ch, int *cnt)
\/
cons_putc(int ch)
*/</span>

<span class="c1">// Output: Numbers x= //</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">f</span>
<span class="cp">#2  0xf0100911 in vcprintf (fmt=0xf01019b3 "Numbers x=%d y=%d z=%d\n", 
</span>    <span class="n">ap</span><span class="o">=</span><span class="mh">0xf010afc4</span> <span class="s">"</span><span class="se">\001</span><span class="s">"</span><span class="p">)</span> <span class="n">at</span> <span class="n">kern</span><span class="o">/</span><span class="n">printf</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">21</span>
<span class="mi">21</span>              <span class="nf">vprintfmt</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">putch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cnt</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="n">fmt</span> 
<span class="err">$</span><span class="mi">9</span> <span class="o">=</span> <span class="mh">0xf01019b3</span> <span class="s">"Numbers x=%d y=%d z=%d</span><span class="se">\n</span><span class="s">"</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="n">ap</span>
<span class="err">$</span><span class="mi">10</span> <span class="o">=</span> <span class="p">(</span><span class="kt">va_list</span><span class="p">)</span> <span class="mh">0xf010afc4</span> <span class="s">"</span><span class="se">\001</span><span class="s">"</span>

<span class="c1">// Output: Numbers x=1 //</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">f</span>
<span class="cp">#4  0xf01010ff in vprintfmt (putch=&lt;optimized out&gt;, putdat=0xf010af8c, 
</span>    <span class="n">fmt</span><span class="o">=</span><span class="mh">0xf01019bf</span> <span class="s">" y=%d z=%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ap</span><span class="o">=</span><span class="mh">0xf010afc8</span> <span class="s">"</span><span class="se">\003</span><span class="s">"</span><span class="p">)</span> <span class="n">at</span> <span class="n">lib</span><span class="o">/</span><span class="n">printfmt</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">215</span>
<span class="mi">215</span>           <span class="nf">printnum</span><span class="p">(</span><span class="n">putch</span><span class="p">,</span> <span class="n">putdat</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">padc</span><span class="p">);</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="n">fmt</span> 
<span class="err">$</span><span class="mi">23</span> <span class="o">=</span> <span class="mh">0xf01019bf</span> <span class="s">" y=%d z=%d</span><span class="se">\n</span><span class="s">"</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="n">ap</span>
<span class="err">$</span><span class="mi">24</span> <span class="o">=</span> <span class="p">(</span><span class="kt">va_list</span><span class="p">)</span> <span class="mh">0xf010afc8</span> <span class="s">"</span><span class="se">\003</span><span class="s">"</span>

<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">f</span> 
<span class="cp">#0  cons_putc (c=c@entry=49) at kern/console.c:436
</span><span class="mi">436</span>             <span class="nf">lpt_putc</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="n">c</span>
<span class="err">$</span><span class="mi">25</span> <span class="o">=</span> <span class="mi">49</span>

<span class="c1">// Output: Numbers x=1 y=3 //</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">f</span>
<span class="cp">#4  0xf01010ff in vprintfmt (putch=&lt;optimized out&gt;, putdat=0xf010af8c, 
</span>    <span class="n">fmt</span><span class="o">=</span><span class="mh">0xf01019c4</span> <span class="s">" z=%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ap</span><span class="o">=</span><span class="mh">0xf010afcc</span> <span class="s">"</span><span class="se">\004</span><span class="s">"</span><span class="p">)</span> <span class="n">at</span> <span class="n">lib</span><span class="o">/</span><span class="n">printfmt</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">215</span>
<span class="mi">215</span>           <span class="nf">printnum</span><span class="p">(</span><span class="n">putch</span><span class="p">,</span> <span class="n">putdat</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">padc</span><span class="p">);</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="n">fmt</span> 
<span class="err">$</span><span class="mi">32</span> <span class="o">=</span> <span class="mh">0xf01019c4</span> <span class="s">" z=%d</span><span class="se">\n</span><span class="s">"</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="n">ap</span> 
<span class="err">$</span><span class="mi">33</span> <span class="o">=</span> <span class="p">(</span><span class="kt">va_list</span><span class="p">)</span> <span class="mh">0xf010afcc</span> <span class="s">"</span><span class="se">\004</span><span class="s">"</span>

<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">f</span>
<span class="cp">#0  cons_putc (c=c@entry=51) at kern/console.c:436
</span><span class="mi">436</span>             <span class="nf">lpt_putc</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="n">c</span>
<span class="err">$</span><span class="mi">34</span> <span class="o">=</span> <span class="mi">51</span>


</code></pre></div></div> <p>As above show, x86 calling convention passing argument Rigth to Left pushed them into stack, so <code class="language-plaintext highlighter-rouge">va_list ap</code> is <code class="language-plaintext highlighter-rouge">0xf010afc4 -&gt; 0xf010afc8 -&gt; 0xf010afcc</code>, to access the arguments address. The <code class="language-plaintext highlighter-rouge">va_arg()</code> finishd the stack address changed.</p> <blockquote> <p><code class="language-plaintext highlighter-rouge">[Q]?</code> What is the output? Explain how this output is arrived at in the step-by-step manner of the previous exercise:</p> </blockquote> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x00646c72</span><span class="p">;</span>
<span class="n">cprintf</span><span class="p">(</span><span class="s">"H%x Wo%s"</span><span class="p">,</span> <span class="mi">57616</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>

</code></pre></div></div> <p><strong>Output:</strong></p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Print</span> <span class="n">i</span><span class="o">:</span> <span class="n">He110</span> <span class="n">World</span>
</code></pre></div></div> <p>Because 57616(hex) = e110(decimal), <code class="language-plaintext highlighter-rouge">va_arg()</code> parsed <code class="language-plaintext highlighter-rouge">&amp;i</code> as <code class="language-plaintext highlighter-rouge">rld</code>.</p> <blockquote> <p><code class="language-plaintext highlighter-rouge">[Q]?</code> what is going to be printed after ‘y=’? (note: the answer is not a specific value.) Why does this happen?</p> </blockquote> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cprintf</span><span class="p">(</span><span class="s">"x=%d, y=%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
</code></pre></div></div> <p>output <code class="language-plaintext highlighter-rouge">x-3, y=-2671xxx</code>, because using the statement <code class="language-plaintext highlighter-rouge">unsigned long long num = static long long getint()</code>, then <code class="language-plaintext highlighter-rouge">(long long)num</code> trigger the type overflow.</p> <blockquote> <p><code class="language-plaintext highlighter-rouge">[Q]?</code> Let’s say that GCC changed its calling convention so that it pushed arguments on the stack in declaration order, so that the last argument is pushed last. How would you have to change cprintf or its interface so that it would still be possible to pass it a variable number of arguments?</p> </blockquote> <p>[TODO] HARD!!!</p> <hr> <h5 id="challenge">Challenge</h5> <p><strong>Enhance the console to allow text to be printed in different colors. If you’re feeling really adventurous, you could try switching the VGA hardware into a graphics mode and making the console draw text onto the graphical frame buffer.</strong> <br> Console printed in different colors, easy.<br> switching VGA to graphics mode? quit. <br> —</p> <h4 id="stack">Stack</h4> <hr> <ul> <li>Ex.9: Determine where the kernel initializes its stack, and exactly where in memory its stack is located. How does the kernel reserve space for its stack? And at which “end” of this reserved area is the stack pointer initialized to point to?</li> </ul> <p>Before call any C function, the machine should initialized stack work done. So the stack initialized in <code class="language-plaintext highlighter-rouge">entry.S:relocated</code>. After virtual address paging.<br> <code class="language-plaintext highlighter-rouge">entry.S:reloacted</code> clear the <code class="language-plaintext highlighter-rouge">EBP</code> register, and Using GDB can see that <code class="language-plaintext highlighter-rouge">ESP</code> start from <code class="language-plaintext highlighter-rouge">0xf010b00</code>.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Section</span> <span class="n">Headers</span><span class="o">:</span>
  <span class="p">[</span><span class="n">Nr</span><span class="p">]</span> <span class="n">Name</span>              <span class="n">Type</span>            <span class="n">Addr</span>     <span class="n">Off</span>    <span class="n">Size</span>   
  <span class="p">[</span> <span class="mi">0</span><span class="p">]</span>                   <span class="nb">NULL</span>            <span class="mo">00000000</span> <span class="mo">000000</span> <span class="mo">000000</span> 
  <span class="p">[</span> <span class="mi">1</span><span class="p">]</span> <span class="p">.</span><span class="n">text</span>             <span class="n">PROGBITS</span>        <span class="n">f0100000</span> <span class="mo">001000</span> <span class="mo">001</span><span class="mi">94</span><span class="n">d</span> 
  <span class="p">[</span> <span class="mi">2</span><span class="p">]</span> <span class="p">.</span><span class="n">rodata</span>           <span class="n">PROGBITS</span>        <span class="n">f0101960</span> <span class="mo">002</span><span class="mi">960</span> <span class="mo">000</span><span class="mi">80</span><span class="n">c</span> 
  <span class="p">[</span> <span class="mi">3</span><span class="p">]</span> <span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">pr</span><span class="p">[...]</span> <span class="n">NOTE</span>            <span class="n">f010216c</span> <span class="mo">00316</span><span class="n">c</span> <span class="mo">00002</span><span class="mi">8</span> 
  <span class="p">[</span> <span class="mi">4</span><span class="p">]</span> <span class="p">.</span><span class="n">stab</span>             <span class="n">PROGBITS</span>        <span class="n">f0102194</span> <span class="mo">0031</span><span class="mi">94</span> <span class="mo">000001</span> 
  <span class="p">[</span> <span class="mi">5</span><span class="p">]</span> <span class="p">.</span><span class="n">stabstr</span>          <span class="n">STRTAB</span>          <span class="n">f0102195</span> <span class="mo">0031</span><span class="mi">95</span> <span class="mo">000001</span> 
  <span class="p">[</span> <span class="mi">6</span><span class="p">]</span> <span class="p">.</span><span class="n">data</span>             <span class="n">PROGBITS</span>        <span class="n">f0103000</span> <span class="mo">004000</span> <span class="mo">00</span><span class="n">a300</span>
  <span class="p">[</span> <span class="mi">7</span><span class="p">]</span> <span class="p">.</span><span class="n">bss</span>              <span class="n">PROGBITS</span>        <span class="n">f010d300</span> <span class="mf">00e300</span> <span class="mo">000661</span> 

</code></pre></div></div> <p>And in <code class="language-plaintext highlighter-rouge">entry.S</code>:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">relocated:</span>

	<span class="n">movl</span>	<span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="o">%</span><span class="n">ebp</span>			<span class="err">#</span> <span class="n">nuke</span> <span class="n">frame</span> <span class="n">pointer</span>

	<span class="cp"># Set the stack pointer
</span>	<span class="n">movl</span>	<span class="err">$</span><span class="p">(</span><span class="n">bootstacktop</span><span class="p">),</span><span class="o">%</span><span class="n">esp</span>

	<span class="cp"># now to C code
</span>	<span class="n">call</span>	<span class="n">i386_init</span>

<span class="c1">// ...............</span>
	<span class="p">.</span><span class="n">p2align</span>	<span class="n">PGSHIFT</span>		<span class="err">#</span> <span class="n">force</span> <span class="n">page</span> <span class="n">alignment</span>
	<span class="p">.</span><span class="n">globl</span>		<span class="n">bootstack</span>
<span class="n">bootstack</span><span class="o">:</span>
	<span class="p">.</span><span class="n">space</span>		<span class="n">KSTKSIZE</span>
	<span class="p">.</span><span class="n">globl</span>		<span class="n">bootstacktop</span>   
<span class="n">bootstacktop</span><span class="o">:</span>

</code></pre></div></div> <p>So the stack address space layout:</p> <blockquote> <p>bootstack(0xf010300), also the <code class="language-plaintext highlighter-rouge">.data</code> section link address.<br> bootstacktop(0xf010b00), <code class="language-plaintext highlighter-rouge">ESP</code> start to decrease.<br> <code class="language-plaintext highlighter-rouge">.bss</code> section at (0xf010d300)</p> </blockquote> <p>The kernel link the <code class="language-plaintext highlighter-rouge">ESP</code> at high address to preserve stack address space, the space size = 0xf010b00 - 0xf010300 = 2Kib</p> <hr> <ul> <li>Ex.10: Examine what happens each time it gets called after the kernel starts. How many 32-bit words does each recursive nesting level of test_backtrace push on the stack, and what are those words? <br> After first call at <code class="language-plaintext highlighter-rouge">init.c:i386_init()</code>, every time nested call will push 5 32-bit words before.<br> First call set <code class="language-plaintext highlighter-rouge">%EAX</code> store arguments ‘five’. Then every nested call will pretend/know that <code class="language-plaintext highlighter-rouge">%EAX</code> holds this call fram function argument.<br> Then will push <code class="language-plaintext highlighter-rouge">%EBP %EBX %EBX(After set as %EAX value) $0xf0101960 %EAX(After calculated minos 1)</code>.</li> </ul> <hr> <ul> <li>Ex.11: mon_backtrace() function.</li> </ul> <p>OK!!</p> <ul> <li>Ex.12: Modify your stack backtrace function to display, for each eip, the function name, source file name, and line number corresponding to that eip.</li> </ul> <p>[TODO]</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/courses-for-undergraduates-ipads/">Courses for Undergraduates [IPADS]</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/expanded-main-page-osdev-wiki/">Expanded Main Page - OSDev Wiki</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/KMPBM/">KMP/BM String Match Algorithm</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/linux-sources/">Linux resources manage tools</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/code/">C/CPP VSCode configure</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 JLibyvali . Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. Last updated: February 01, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.4/dist/bootstrap-table.min.js" integrity="sha256-4rppopQE9POKfukn2kEvhJ9Um25Cf6+IDVkARD0xh78=" crossorigin="anonymous"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-15DF4WW95V"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-15DF4WW95V");</script> <script async src="https://rum.cronitor.io/script.js"></script> <script>window.cronitor=window.cronitor||function(){(window.cronitor.q=window.cronitor.q||[]).push(arguments)},cronitor("config",{clientKey:"a0e446488daaed90d1c939ef358fa4b4"});</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script type="module" src="/assets/js/search/ninja-keys.min.js?601a2d3465e2a52bec38b600518d5f70"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script>let searchTheme=determineComputedTheme();const ninjaKeys=document.querySelector("ninja-keys");"dark"===searchTheme?ninjaKeys.classList.add("dark"):ninjaKeys.classList.remove("dark");const openSearchModal=()=>{const e=$("#navbarNav");e.hasClass("show")&&e.collapse("hide"),ninjaKeys.open()};</script> <script>const ninja=document.querySelector("ninja-keys");ninja.data=[{id:"nav-home",title:"Home",section:"Navigation",handler:()=>{window.location.href="/"}},{id:"nav-blog",title:"blog",description:"",section:"Navigation",handler:()=>{window.location.href="/blog/"}},{id:"nav-publications",title:"publications",description:"some publications I read.",section:"Navigation",handler:()=>{window.location.href="/publications/"}},{id:"post-mit6-828-fall-2018-lab-1",title:"MIT6.828/fall 2018 Lab 1",description:"Notes about lab 1",section:"Posts",handler:()=>{window.location.href="/blog/2025/MITLAB1/"}},{id:"post-kmp-bm-string-match-algorithm",title:"KMP/BM String Match Algorithm",description:"Recording the algorithm implementation",section:"Posts",handler:()=>{window.location.href="/blog/2025/KMPBM/"}},{id:"post-linux-resources-manage-tools",title:"Linux resources manage tools",description:"record common vscode configuration",section:"Posts",handler:()=>{window.location.href="/blog/2024/linux-sources/"}},{id:"post-c-cpp-vscode-configure",title:"C/CPP VSCode configure",description:"Some configurations for vscode develop quickly.",section:"Posts",handler:()=>{window.location.href="/blog/2024/code/"}},{id:"post-expanded-main-page-osdev-wiki",title:'Expanded Main Page - OSDev Wiki <svg width="1.2rem" height="1.2rem" top=".5rem" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg>',description:"",section:"Posts",handler:()=>{window.open("https://wiki.osdev.org/Expanded_Main_Page","_blank")}},{id:"post-opensuse-network-configuration",title:"Opensuse Network Configuration",description:"recording the common NetworkManger configuration",section:"Posts",handler:()=>{window.location.href="/blog/2023/opensuse-network/"}},{id:"post-clash-verge-tun-mode",title:"clash verge tun mode",description:"",section:"Posts",handler:()=>{window.location.href="/blog/2023/clah-verge/"}},{id:"post-courses-for-undergraduates-ipads",title:'Courses for Undergraduates [IPADS] <svg width="1.2rem" height="1.2rem" top=".5rem" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg>',description:"",section:"Posts",handler:()=>{window.open("https://ipads.se.sjtu.edu.cn/pub/courses","_blank")}},{id:"post-clash-verge-tun-mode",title:"clash verge tun mode",description:"",section:"Posts",handler:()=>{window.location.href="/blog/2022/esp32-arduino/"}},{id:"socials-email",title:"Send email",section:"Socials",handler:()=>{window.open("mailto:%6C%69%62%79%76%61%6C%69.%6C%69%6E%65@%67%6D%61%69%6C.%63%6F%6D","_blank")}},{id:"socials-github",title:"GitHub",section:"Socials",handler:()=>{window.open("https://github.com/JLibyvali","_blank")}},{id:"light-theme",title:"Change theme to light",description:"Change the theme of the site to Light",section:"Theme",handler:()=>{setThemeSetting("light")}},{id:"dark-theme",title:"Change theme to dark",description:"Change the theme of the site to Dark",section:"Theme",handler:()=>{setThemeSetting("dark")}},{id:"system-theme",title:"Use system default theme",description:"Change the theme of the site to System Default",section:"Theme",handler:()=>{setThemeSetting("system")}}];</script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>
---
layout: post
title: KMP/BM String Match Algorithm
date: 2025-01-10 21:01:00
description: Recording the algorithm implementation
tags: algorithm
categories: code
thumbnail: assets/img/bm_kmp/long_bm.png
toc:
  beginning: true
---

# Intro
花了两天时间,终于把KMP和BM算法弄懂了. 本编文章将介绍KMP和BM相关算法的实现以及过程,并引入`Google Benchmark`作初步性能测试.  
本编不追求底层理论证明,只用图表和代码阐述算法实现及思想. 

## TL;DR
* 性能对比图

> `PATTERN`字符串只在`TEXT`的尾部, 中点处 出现两次, 稀疏匹配, 横坐标为搜索的`TEXT`串长度, [100,10M] 个字符, 纵坐标为`benchmark`消耗的cpu时间

* 短序列匹配(length<=5)  

pattern: `    std::string           short_pattern{"abca"};`  

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/bm_kmp/short_bm.png" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    短序列稀疏匹配.  
</div>

* 中序列匹配(5<length<=30)  

pattern: `    std::string           medium_pattern{"HelloWWWorldHello"};`  

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/bm_kmp/medium_bm.png" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    中序列稀疏匹配.  
</div>

* 长序列匹配(length>30)

pattern: `    std::string           long_pattern{"This isis long patternpattern string matched testThislongpatternpat"};`  

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/bm_kmp/long_bm.png" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    长序列稀疏匹配.  
</div>


# KMP  

先讲`KMP`算法, 先要了解概念: 字符串的`真前缀`, `真后缀`.   
真前缀:  就是除了字符串`s`本身外的所有前缀, 比如串`abcda`, 则真前缀为`a`, `ab`, `abc`, `abcd`.   
真后缀: 同理, 就是除了s本身外的所有后缀, 比如串`abcda`, 则真后缀为`a`, `da`, `cda`, `bcda`.  

## 朴素算法  

先来看一下朴素匹配算法:  文本串`TEXT = goodgoogle`, 模式串`PAT=google`. 

{% highlight c++ linenos %}

std::vector<int> naive_match(std::string_view _text, std::string_view _pat)
{
    std::vector<int> pos;

    auto             text_len = _text.length();
    auto             pat_len  = _pat.length();

    for (int i = 0; i < text_len; i++)
    {
        bool matched = true;
        for (int j = 0; j < pat_len; j++)
        {
            if (_text[i + j] != _pat[j])
                matched = false;
        }

        if (matched)
            pos.push_back(i);
    }

    return pos;
}

int main()
{
    std::string TEXT = "goodgoogle.";
    std::string PAT  = "google";

    auto        pos  = naive_match(TEXT, PAT);
    if (!pos.empty())
    {
        for (const auto &p : pos)
        {
            std::cout << "Matched: " << TEXT.substr(p, PAT.length()) << std::endl;
        }
    }
    return 0;
}

{% endhighlight %}  

> 输出:
> Matched: google  


但这样无疑是非常慢的,而且重复匹配了很多可以跳过的步骤.  如图:  

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/bm_kmp/1.jpeg" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>


<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/bm_kmp/2.jpeg" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>


<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/bm_kmp/3.jpeg" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>


<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/bm_kmp/4.jpeg" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>


<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/bm_kmp/5.jpeg" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>


`PAT[j]` 的索引 j  发生了回溯, 比如`1 -> 2`中, j从`3` 到了 `0`后又开始匹配,  这些回溯是可以被减少或取消的.  


>  第一次在`g` 失配后,2, 3 的匹配完全可以跳过直接到 4 .  



<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/bm_kmp/1_4.jpeg" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>

